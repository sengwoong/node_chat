<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Desktop Screen Recording & Streaming</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #videoContainer {
      margin: 20px 0;
    }
    #myVideo {
      width: 640px;
      height: 480px;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
    }
    .controls {
      margin-top: 15px;
    }
    button {
      padding: 8px 16px;
      margin-right: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #45a049;
    }
    #recordingStatus {
      margin-top: 10px;
      color: #666;
    }
    .stream-info {
      margin-top: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 4px;
      display: none;
    }
    .stream-info h3 {
      margin-top: 0;
    }
    .stream-link {
      color: #2196F3;
      text-decoration: none;
      font-weight: bold;
    }
    .stream-link:hover {
      text-decoration: underline;
    }
    .qr-code {
      margin-top: 10px;
    }
    .error-message {
      color: #e74c3c;
      font-weight: bold;
      margin-top: 10px;
      padding: 10px;
      background-color: #ffeaea;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Desktop Screen Recording & Streaming</h1>
  
  <div id="videoContainer">
    <video id="myVideo" autoplay muted></video>
  </div>
  
  <div class="controls">
    <button id="selectSource">화면 선택</button>
    <button id="startRecording" disabled>녹화 시작</button>
    <button id="stopRecording" disabled>녹화 중지</button>
  </div>
  
  <div id="recordingStatus"></div>
  <div id="errorMessage" class="error-message"></div>
  
  <div id="streamInfo" class="stream-info">
    <h3>실시간 스트리밍 정보</h3>
    <p>시청자 URL: <a id="viewerLink" class="stream-link" target="_blank">링크 로딩 중...</a></p>
    <p>스트림 ID: <span id="streamId">로딩 중...</span></p>
    <div class="qr-code">
      <p>QR 코드로 스캔하여 모바일에서 시청:</p>
      <img id="qrCode" src="" alt="QR Code" height="150">
    </div>
  </div>
  
  <script>
    // 서버 베이스 URL 설정 (포트 포함)
    const serverBaseUrl = 'http://localhost:8080'; // 서버가 실행 중인 포트로 설정
    
    let videoElement = document.getElementById("myVideo");
    let selectButton = document.getElementById("selectSource");
    let startButton = document.getElementById("startRecording");
    let stopButton = document.getElementById("stopRecording");
    let statusElement = document.getElementById("recordingStatus");
    let errorElement = document.getElementById("errorMessage");
    let streamInfoElement = document.getElementById("streamInfo");
    let viewerLinkElement = document.getElementById("viewerLink");
    let streamIdElement = document.getElementById("streamId");
    let qrCodeElement = document.getElementById("qrCode");
    
    let mediaRecorder;
    let recordedChunks = [];
    let stream;
    let currentStreamId = null;
    
    // 오류 표시 함수
    function showError(message) {
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      console.error(message);
    }
    
    // 메시지 표시 함수
    function showStatus(message) {
      statusElement.textContent = message;
    }
    
    // Select screen to record
    async function selectScreen() {
      try {
        stream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            cursor: "always"
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        videoElement.srcObject = stream;
        showStatus("화면 캡처 준비 완료. 녹화 시작 버튼을 클릭하세요.");
        errorElement.style.display = 'none';
        
        // Enable start recording button
        selectButton.disabled = true;
        startButton.disabled = false;
        
        // Handle the stream ending (user clicks "Stop sharing")
        stream.getVideoTracks()[0].addEventListener('ended', () => {
          showStatus("화면 공유가 중지되었습니다. 다시 화면을 선택하세요.");
          selectButton.disabled = false;
          startButton.disabled = true;
          stopButton.disabled = true;
          resetStreamInfo();
        });
        
      } catch (err) {
        console.error("Error accessing screen:", err);
        showError("화면 캡처 오류: " + err.message);
      }
    }
    
    // Start recording
    function startRecording() {
      recordedChunks = [];
      
      // Create MediaRecorder with the stream
      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });
      
      // Handle data available event
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      
      // Handle recording stop event
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        uploadVideo(blob);
      };
      
      // Set data available every second to enable streaming
      mediaRecorder.start(1000);
      
      // Update UI
      startButton.disabled = true;
      stopButton.disabled = false;
      showStatus("녹화 중...");
      
      // Create Blob URL and upload first chunk to start streaming
      setTimeout(() => {
        if (recordedChunks.length > 0) {
          const initialBlob = new Blob(recordedChunks, { type: "video/webm" });
          startStreaming(initialBlob);
        }
      }, 1500);
    }
    
    // Stop recording
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        
        // Update UI
        startButton.disabled = false;
        stopButton.disabled = true;
        showStatus("녹화 중지됨. 변환 및 다운로드 준비 중...");
        
        // Get the final recording if streaming was active
        if (currentStreamId) {
          downloadRecording();
        }
      }
    }
    
    // Start streaming
    async function startStreaming(blob) {
      const formData = new FormData();
      formData.append("video", blob, "video.webm");
      
      try {
        showStatus("스트리밍 시작 중...");
        
        const response = await fetch(`${serverBaseUrl}/upload`, {
          method: "POST",
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`서버 응답 오류: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        currentStreamId = data.streamId;
        
        // Show streaming info
        streamInfoElement.style.display = "block";
        const viewerUrl = `${serverBaseUrl}/view/${data.streamId}`;
        viewerLinkElement.href = viewerUrl;
        viewerLinkElement.textContent = viewerUrl;
        streamIdElement.textContent = data.streamId;
        
        // Generate QR code for the viewer link
        qrCodeElement.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(viewerUrl)}`;
        
        showStatus("녹화 및 실시간 스트리밍 중...");
        errorElement.style.display = 'none';
      } catch (err) {
        console.error("Error starting stream:", err);
        showError("스트리밍 시작 실패: " + err.message);
      }
    }
    
    // Download the recording after stopping
    async function downloadRecording() {
      try {
        showStatus("녹화 파일 다운로드 중...");
        
        const response = await fetch(`${serverBaseUrl}/stop-stream/${currentStreamId}`, {
          method: "POST"
        });
        
        if (!response.ok) {
          throw new Error(`서버 응답 오류: ${response.status} ${response.statusText}`);
        }
        
        // Get the video file as a blob
        const fileBlob = await response.blob();
        
        // Create a download link
        const downloadUrl = URL.createObjectURL(fileBlob);
        const a = document.createElement("a");
        a.href = downloadUrl;
        a.download = "screen_recording.mp4";
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showStatus("완료! MP4 파일을 다운로드합니다.");
        selectButton.disabled = false;
        resetStreamInfo();
        errorElement.style.display = 'none';
      } catch (err) {
        console.error("Error downloading recording:", err);
        showError("다운로드 실패: " + err.message);
        selectButton.disabled = false;
      }
    }
    
    // Upload video for non-streaming mode (fallback)
    async function uploadVideo(blob) {
      // If streaming is active, we don't need to do this
      if (currentStreamId) return;
      
      const formData = new FormData();
      formData.append("video", blob, "video.webm");
      
      try {
        showStatus("서버에 업로드 중...");
        
        const response = await fetch(`${serverBaseUrl}/upload`, {
          method: "POST",
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`서버 응답 오류: ${response.status} ${response.statusText}`);
        }
        
        showStatus("업로드 완료! 다운로드 준비 중...");
        
        // Get the video file as a blob
        const fileBlob = await response.blob();
        
        // Create a download link
        const downloadUrl = URL.createObjectURL(fileBlob);
        const a = document.createElement("a");
        a.href = downloadUrl;
        a.download = "recorded_video.mp4";
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showStatus("완료! MP4 파일을 다운로드합니다.");
        selectButton.disabled = false;
        errorElement.style.display = 'none';
      } catch (err) {
        console.error("Error uploading video:", err);
        showError("업로드 실패: " + err.message);
        selectButton.disabled = false;
      }
    }
    
    // Reset streaming info
    function resetStreamInfo() {
      streamInfoElement.style.display = "none";
      currentStreamId = null;
    }
    
    // Event listeners
    selectButton.addEventListener("click", selectScreen);
    startButton.addEventListener("click", startRecording);
    stopButton.addEventListener("click", stopRecording);
  </script>
</body>
</html> 